name: Record Feedback

on:
  issues:
    types: [closed]

jobs:
  record-feedback:
    if: contains(github.event.issue.labels.*.name, 'news')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    steps:
      - name: Check if reactions exist
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          REACTIONS=$(gh api repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/reactions --jq '[.[].content] | unique')
          if echo "$REACTIONS" | grep -qE '"\+1"|"-1"'; then
            echo "has_feedback=true" >> $GITHUB_OUTPUT
          else
            echo "has_feedback=false" >> $GITHUB_OUTPUT
            echo "No ğŸ‘ or ğŸ‘ reactions found, skipping..."
          fi

      - name: Checkout repository
        if: steps.check.outputs.has_feedback == 'true'
        uses: actions/checkout@v5

      - name: Record feedback
        if: steps.check.outputs.has_feedback == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
          REACTIONS=$(gh api repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/reactions --jq '[.[].content] | unique')

          # URLã‚’æœ¬æ–‡ã‹ã‚‰æŠ½å‡º
          URL=$(echo "$ISSUE_BODY" | grep -oP 'https?://[^\s\)]+' | head -1)

          # ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆ
          ENTRY="- ${ISSUE_TITLE} | ${URL}"

          CHANGED=false

          # ğŸ‘ ãŒã‚ã‚Œã° likes.md ã«è¿½è¨˜
          if echo "$REACTIONS" | grep -q '"+1"'; then
            echo "$ENTRY" >> likes.md
            CHANGED=true
          fi

          # ğŸ‘ ãŒã‚ã‚Œã° dislikes.md ã«è¿½è¨˜
          if echo "$REACTIONS" | grep -q '"-1"'; then
            echo "$ENTRY" >> dislikes.md
            CHANGED=true
          fi

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
          if [ "$CHANGED" = true ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add likes.md dislikes.md
            git commit -m "Record feedback for #${ISSUE_NUMBER}"
            git push
          fi
